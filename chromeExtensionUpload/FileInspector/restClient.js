import { config } from '@UtilityFiles/config';
import { FileStatus } from './FileStatus.mjs';
//import { SEALWrapper } from './fHE';
//import { Buffer } from 'buffer';
//import {fileTypeFromFile} from 'file-type';

//let fHE = new SEALWrapper();
const json_headers =  {
    'Content-Type': 'application/json'
};
const CHUNK_SIZE = 4194304;



/**
 * @param {File} file
 * @param {CardItem~setProgressBar} fileUploadCallback
 * @return {json}
 */
async function requestScanFile(file, fileUploadCallback, encrypt=false) {
    const uri = config.debug ? config.debughosturi : config.hosturi;
    
    const data = (new Uint8Array(await file.arrayBuffer()))
    let ind = 0;
    fileUploadCallback(0, data.lenth);
    while(ind < data.length) {
        const next_ind = Math.min(ind + CHUNK_SIZE, data.length);
        const messageBody = data.subarray(ind, next_ind).toString();// Buffer.from(data.subarray(ind, next_ind))// .toString('utf8')//.join("");//Buffer.from(data).toString();
        let body = { 
            name: file.name, 
            data: messageBody, 
            start: ind, 
            end: next_ind,
            lastMessage: next_ind >= data.length 
        }
        if(config.debug)
            console.log("sending ", file.name, ind, next_ind)
        try {
            const request = {
                method: 'POST',
                body: JSON.stringify(body),
                headers: json_headers,
            };
            const response = await fetch(uri + '/scan', request);
            if(!response.ok) {
                throw new Error('bad response', {
                    cause: {
                        response,
                    }
                })
            }
            ind = next_ind;
            const resObj = await response.json();
            if(config.debug)
                console.log(resObj);
            if(resObj['status'] != 'parsing' && resObj['status'] != 'complete') {
                return resObj;
            } else if(resObj['status'] == 'parsing') {
                fileUploadCallback(ind, data.lenth);
            } else if(resObj['status'] == 'complete') {
                fileUploadCallback(data.length, data.length);
                return resObj;
            } else {
                console.error("something went wrong!");
            }
        } catch (err) {
            if(config.debug)
                console.error(err);
            return FileStatus.FailedToFetch;
        }
    }
    return FileStatus.Unreachable;
}

/**
 * 
 * @param {string} uri 
async function getAsFile(uri) {
    const res = await fetch(uri);
    const blob = await res.blob();
    const types = await fileTypeFromFile(uri);
    const metadata = {
        type : types.mime,
    };
    return new File([blob], uri, metadata);
}

 */
export {requestScanFile}; //, getAsFile};