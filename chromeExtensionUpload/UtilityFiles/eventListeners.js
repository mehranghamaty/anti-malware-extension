import { CardHolder } from "../UIElements/cardHolder";

/**
 * @param {CardHolder} cardHolder 
 * @returns 
 */
function dropHandler(cardHolder) {
    return (ev) => {
        console.log("File(s) dropped");
    
        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
    
        if (ev.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            [...ev.dataTransfer.items].forEach(async (item, i) => {
                // If dropped items aren't files, reject them
                if (item.kind === "file") {
                    const file = item.getAsFile();
                    cardHolder.addCardFromFile(file);
                    console.log(`… file[${i}].name = ${file.name}`);
                }
            });
        } else {
            // Use DataTransfer interface to access the file(s)
            [...ev.dataTransfer.files].forEach(async (file, i) => {
                cardHolder.addCardFromFile(file);
                console.log(`… file[${i}].name = ${file.name}`);
            });
        }
    }
}

/**
 * @param {CardHolder} cardHolder 
 * @returns 
 */
function findAndDisplayLinks(cardHolder) {
    function getLinks() {
        const FileTypes = new Set(['exe', 'dmg', 'pdf', 'png', 'apk']);

        /**
         * @param {string} uri 
         * @return {string | null}
         */
        function getExtension(uri) {
            const lastSlash = Math.max(uri.lastIndexOf('/'), 0)+1;
            const uriShortended = uri.substring(lastSlash)
            const lastPeriod = lastSlash + uriShortended.lastIndexOf('.')+1;
            if(lastPeriod === -1)
                return null;
            const ext = uri.substring(lastPeriod);
            if(ext === '')
                return null;
            return ext;
        }

        /**
         * @param {HTMLAnchorElement | HTMLAreaElement} anchor 
         * @return {boolean}
         */
        function shouldInspect(link) {
            const ext = getExtension(link.href);
            if(ext) {
                return FileTypes.has(ext.trim());
            }
            return false;
        }

        var links = new Set();
        for(const link of document.links) {
            if(shouldInspect(link)) {
                links.add(link.href);
            }
        }

        return JSON.stringify(Array.from(links));
    }

    function runOnTab(tab, cardHolder) {
        return chrome.scripting.executeScript({
            target: {tabId: tab.id, allFrames: true}, 
            func : getLinks,
            // https://stackoverflow.com/questions/66772626/chrome-scripting-executescript-not-working-in-my-manifest-v3-chrome-extension
            // either have to update chrome...
            // files: ['asdfasdfsdfsdaf.js']
        }).then((injectionResults) => {
            for (const {frameId, result} of injectionResults) {
                const linksOfInterest = JSON.parse(result);
                if(linksOfInterest.length == 0) {
                    continue;
                }
                console.log(`Frame ${frameId} result:`, result);
                for(const link of linksOfInterest) {
                    cardHolder.addCardFromUri(link);
                }
            }
        });
    }

    function toRunOnTabs(cardHolder) {
        return (tabs) => {
            for(let i = 0; i < tabs.length; ++i) {
                runOnTab(tabs[i], cardHolder);
            }
        }
    }

    function injectScript(cardHolder) {
        const queryOptions = { active: true, currentWindow: true };
        chrome.tabs.query(queryOptions, toRunOnTabs(cardHolder));
    }

    return () => {
        console.log('pressed the upload button');
        injectScript(cardHolder);
    }
}

/**
 * @param {Event} ev 
 */
function dragOverHandler(ev) {
        console.log("File(s) in drop zone");
        ev.preventDefault();
}

export {dropHandler, dragOverHandler, findAndDisplayLinks};