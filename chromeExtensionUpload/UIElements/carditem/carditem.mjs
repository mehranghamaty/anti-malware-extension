import AncilliaryButton from '@UIElements/ancilliarybutton.mjs';
import InfoTag from '@UIElements/infotag.mjs';
import { inspectFile } from '@FileInspector/fileInspect.js';

/**
 * Tag populates the inner items itself.
 * <card-item>
 *  <p uri>http://Downloadpath...</p>
 *  <div status></div>
 *  <ancilliary-button></ancilliary-button>
 *  <info-tag></info-tag>
 * </card-item>
 * @class CardItem
 */
export default class CardItem extends HTMLElement {


    constructor() {
        super();

        this._uri = document.createElement("p");
        this._uri.setAttribute("uri", "");

        this._status = document.createElement("div");
        this._status.setAttribute("status", "");

        this._ancilliarybutton = new AncilliaryButton();
        this._infotag = new InfoTag();

        this.appendChild(this._uri);
        this.appendChild(this._status);
        this.appendChild(this._ancilliarybutton);
        this.appendChild(this._infotag);

        this._progressbar = document.createElement("progress");
    }

    /**
     * @param {File} file
     */
    setFile(file) {
        this._uri.textContent = file.name;
        
        this._status.appendChild(this._progressbar);
        this._progressbar.setAttribute("value", 0);
        this._progressbar.setAttribute("max", file.size);
        let res = inspectFile(file, this.setProgressBar.bind(this));
        res
            .then((final_results) => {
                console.log("Promise resolved successfully");
                try {
                    let scanner_res = final_results.scanner_results;
                    console.log(scanner_res);
                    switch(scanner_res.results) {
                        case 'clean':
                            this.setSafe(file);
                            break;
                        default:
                        case 'no_scan':
                            this.setWarning(scanner_res.reason);
                            break;
                        case 'possibly_malicious':
                            this.setNoDownload("Possibly malicious", scanner_res.reaon);
                            break;
                    }
                } catch(err) {
                    this.setNoDownload("No server response.", "are you connected?")
                }
            })
            .catch((err) => {
                console.error("An issue happened inspecting the file", err);
            });
    }

    /**
         * @param {Number} val 
     */
    setProgressBar(val) {
        this._progressbar.setAttribute("value", val);
    }

    /**
     * @param {string} explanation 
     */
    setTip(explanation) {
        this._infotag.setHint(explanation);
    }

    /**
     * 
     * @param {File} file 
     */
    setSafe(file) {
        this._infotag.classList.remove("warning", "malicious");
        this._infotag.classList.add("safe");
        this.classList.remove("warning", "malicious");
        this.classList.add("safe");
        this.setTip("File is considered safe.");
        this.setStatus("Looks safe to download!");
        this._ancilliarybutton.setDownload(file);
    }

    /**
     * 
     * @param {string} reason 
     */
    setWarning(reason) {
        this._infotag.classList.remove("safe", "malicious");
        this._infotag.classList.add("warning");
        this.classList.remove("safe", "malicious");
        this.classList.add("warning");
        this.setStatus(reason);
        this.setTip("Something went wrong.");
        let callback = () => {console.log("hello world");};
        this._ancilliarybutton.setRetry(callback);
    }


    /**
     * @param {string} message
     * @param {string} reason 
     */
    setNoDownload(message, reason) {
        this._infotag.classList.remove("safe", "warning");
        this._infotag.classList.add("malicious");
        this.classList.remove("safe", "warning");
        this.classList.add("malicious");
        this.setTip(reason);
        this.setStatus(message);
        this._ancilliarybutton.setNoDownload("theres no file!");
    }

    /**
     * 
     * @param {string} message 
     */
    setStatus(message) {
        this._status.innerHTML = message;
    }

}

customElements.define("card-item", CardItem);