from flask import Flask, request, render_template, jsonify
from flask_cors import CORS
from utility.cache import Cache
from scanners.scanWrapper import ScanWrapper
from utility.helpers import scannable


def generateApp(scanner: ScanWrapper) -> Flask:
    app = Flask(__name__)
    CORS(app)
    cache = Cache()

    #app.register_blueprint(scanner.getBluePrint())

    # Routes
    @app.route('/')
    def test():
        #print(request.json)
        return "works!"

    @app.route('/scan', methods = ['POST'])
    def scan():
        #print(request.json)
        name = request.json['name']
        if not scannable(name):
            resp = jsonify({'message' : 'not supported file type'})
            resp.status_code = 400
            return resp
        resp = {'status' : 'parsing'}

        startInd = request.json['start']
        if cache.exists(name) and startInd == 0:
            del cache[name]
        #print(request.json['data'])
        data = bytearray(request.json['data'])
        cache.extend(name, data)

        if request.json['lastMessage']:
            resp['scanner_results'] = scanner.scan(cache[name])
            resp['status'] = 'complete'

        resp = jsonify(resp)
        resp.status_code = 200
        return resp

    return app