
SCOPES = ['https://www.googleapis.com/auth/gmail.send']
SERVICE_ACCOUNT_FILE = "service.json"
RECEIVER = 'mehran@meandering.ai'

from email.message import EmailMessage
import base64
import subprocess
import glob
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError

def run_unittest():
    res = subprocess.run(["python", "-m", "unittest", *glob.glob("*/test_*.py")], 
                         capture_output=True)
    #res = "It'sa me!"
    return str(res)

def main():
    creds = None
    creds = service_account.Credentials.from_service_account_file(
        filename=SERVICE_ACCOUNT_FILE,
        subject=RECEIVER,
        scopes=SCOPES)
    try:
        # Call the Gmail API
        service = build('gmail', 'v1', credentials=creds) 
        message = EmailMessage()
        body_content = run_unittest()
        message.set_content(body_content)
        message['To'] = RECEIVER
        message['From'] = RECEIVER
        message['Subject'] = 'Health Checks'

        encoded_message = base64.urlsafe_b64encode(message.as_bytes()).decode()

        create_message = {
            'raw': encoded_message
        }

        email = service.users().messages().send(userId="me", 
                                                body=create_message).execute()
    except HttpError as error:
        # TODO(developer) - Handle errors from gmail API.
        print(f'An error occurred: {error}')


if __name__ == '__main__':
    main()