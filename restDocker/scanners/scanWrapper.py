from scanners.modelWrapper import ModelWrapper
from scanners.clamAvWrapper import ClamAvWrapper
from scanners.scanner import Scanner
from flask import Blueprint

"""
    Haven't decided if this should have a tracker for things
    such has total amount of requests. Maybe as things expand.
"""
class ScanWrapper(Scanner):
    def __new__(cls):
        if not hasattr(cls, 'instance'):
            cls.instance = super(ScanWrapper, cls).__new__(cls)
        return cls.instance

    def __init__(self) -> None:
        self._inhouseModel = ModelWrapper()
        self._clamAvModel = ClamAvWrapper()
        
        self._bluePrint = Blueprint(
            self.__class__.__name__,
            self.__class__.__name__,
            template_folder="templates")
        
        self._bluePrint.register_blueprint(self._inhouseModel.getBluePrint())
        self._bluePrint.register_blueprint(self._clamAvModel.getBluePrint())

    def avaliable(self) -> bool:
        return True

    def scan(self, data, metadata) -> dict:
        scannerResults = {}
        #print(self._inhouseModel.avaliable(), self._clamAvModel.avaliable())
        if self._inhouseModel.avaliable():
            pred = self._inhouseModel.scan(data, metadata)
            if pred['results'] == 'no_scan':
                if self._clamAvModel.avaliable():
                    pred = self._clamAvModel.scan(data, metadata)
                    scannerResults = pred
                else:
                    scannerResults['method'] = 'None'
                    scannerResults['results'] = 'no_scan'
                    scannerResults['reason'] = 'Server won\'t provide explanation.'
            else:
                scannerResults = pred
        
        return scannerResults
    
    def getBluePrint(self):
        return self._bluePrint
    
    def __del__(self):
        self.close()

    def close(self):
        self._clamAvModel.close()