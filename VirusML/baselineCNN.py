import matplotlib.pyplot as plt
from tensorflow import keras
from helpers import MODEL_FOLDER
import joblib


def saveModel(classifier, acc):
    className = str(classifier)
    className = className[8:17]
    joblib.dump(classifier, "{}/{}.{:.0f}.model".format(MODEL_FOLDER, className, acc*100))
        

datasetpath = './archive/'
training_data = datasetpath + "train/"
test_data = datasetpath + "test/"
image_size = 32

train_ds = keras.utils.image_dataset_from_directory(
    directory= training_data,
    labels='inferred',
    label_mode='categorical',
    batch_size=32,
    image_size=(image_size, image_size))
validation_ds = keras.utils.image_dataset_from_directory(
    directory= test_data,
    labels='inferred',
    label_mode='categorical',
    batch_size=32,
    image_size=(image_size, image_size))



model = keras.applications.MobileNet(
    weights=None, input_shape=(image_size, image_size, 3), classes=10)
print('starting training')
model.compile(optimizer='rmsprop', loss='categorical_crossentropy')
model.fit(train_ds, epochs=50) #, validation_data=validation_ds)
acc = model.evaluate(validation_ds)
print(model)
saveModel(keras.applications.MobileNet, 100-acc)

print('finished fitting')
#loss 0.8191