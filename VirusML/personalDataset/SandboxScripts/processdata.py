
import sys
if len(sys.argv) < 2:
    print(f"Usage: {sys.argv[0]} folder_to_convert ...")
    exit(1)

import pandas as pd
import pefile

TRAIN_RESULT="../train.csv"

datasets = sys.argv[1:]

labels = [ "label" ]
labels.extend(f"pixel{i}" for i in range(1, 1025))
labels.append("hash")
dataset = { x: list() for x in labels }

def addToDS(filedata):
    dataset["label"].append(0)
    pe = pefile.PE(data=filedata)
    for i, b in enumerate(pe.header):
        pixelval = i+1
        dataset[f"pixel{pixelval}"] = b
    dataset["hash"] = "x"


import os

for datasetpath in datasets:
    for filename in os.listdir(datasetpath):
        if(filename[-3:] == 'exe'):
            filepath = os.path.join(datasetpath, filename)
            with open(filepath, 'rb') as f: # open in readonly mode
                print(filepath)
                data = f.read()
                print(data)
                try:
                    addToDS(data)
                except:
                    print("DOS Header magic not found for ", filepath)

df = pd.DataFrame.from_dict(dataset)
df = df.reset_index(drop=True)
df.to_csv(TRAIN_RESULT)
